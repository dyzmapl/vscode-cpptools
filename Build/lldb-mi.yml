variables:
  llvm_repo: https://github.com/llvm/llvm-project.git
  llvm_branch: release/10.x
  llvm_build_type: Release
  llvm_arch: x86_64
  llvm_additional_parameters: "-DLLDB_RELOCATABLE_PYTHON=1 -DLLDB_INCLUDE_TESTS=OFF -DLLDB_BUILD_FRAMEWORK=1"
  lldb_mi_repo: https://github.com/lldb-tools/lldb-mi
  lldb_mi_branch: origin/master
  lldb_mi_additional_parameters: "-DUSE_LLDB_FRAMEWORK=1"

jobs:
- job: LLDB_MI
  timeoutInMinutes: 360
  pool:
    vmImage: 'macOS-latest'
  steps:
  - task: CmdLine@2
    displayName: 'Install Dependencies'
    inputs: 
      script: brew install cmake ninja swig
    continueOnError: true

  - task: CmdLine@2
    displayName: 'Build LLVM Project'
    inputs: 
      script: |
        cd $(Build.StagingDirectory)
        mkdir $(Build.StagingDirectory)/buildspace
        
        git clone $(llvm_repo)
        cd llvm-project
        git checkout $(llvm_branch)

        echo "##[command] ./lldb/scripts/macos-setup-codesign.sh"

        ./lldb/scripts/macos-setup-codesign.sh

        cd ..
        mkdir $(Build.StagingDirectory)/buildspace/llvm-inst
        mkdir $(Build.StagingDirectory)/llvm-build
        cd $(Build.StagingDirectory)/llvm-build

        cmake -DLLVM_ENABLE_PROJECTS="clang;lldb" -DCMAKE_BUILD_TYPE=$(llvm_build_type) -DCMAKE_INSTALL_PREFIX=$(Build.StagingDirectory)/buildspace/llvm-inst/ -DCMAKE_OSX_ARCHITECTURES=$(llvm_arch) $(llvm_additional_parameters) -GNinja $(Build.StagingDirectory)/llvm-project/llvm
        if [[ $? -ne 0 ]]
        then
          echo "##[error] cmake llvm failed"
          cat $(Build.SourcesDirectory)/llvm-build/CMakeFiles/CMakeError.log
          exit 1
        fi

        echo "##[command] ninja"
        ninja
        if [[ $? -ne 0 ]]
        then
          echo "##[error] ninja failed"
          exit 1
        fi

        echo "##[command] ninja install"
        ninja install || true # this install will fail.

        # Workaround to build lldb/sources/API first
        rm -rf $(Build.SourcesDirectory)/llvm-inst/Library/Frameworks/LLDB.framework/Resources/
        cmake -P tools/lldb/source/API/cmake_install.cmake

        ninja install
        if [[ $? -ne 0 ]]
        then
          echo "##[error] ninja install failed"
          exit 1
        fi

        echo "##[section] Build LLDB-MI"
        # Download lldb-mi and build it against our custom installation.
        cd $(Build.StagingDirectory)/buildspace
        git clone $(lldb_mi_repo)
        cd lldb-mi
        git checkout $(lldb_mi_branch)

        # Create a separate build directory for building lldb-mi.
        mkdir build
        cd build
        cmake -DCMAKE_PREFIX_PATH=$(Build.StagingDirectory)/buildspace/llvm-inst/ $(lldb_mi_additional_parameters) -GNinja ..
        ninja

        mkdir $(Build.StagingDirectory)/publish
        cd $(Build.StagingDirectory)/publish

        mkdir bin

        cp $(Build.StagingDirectory)/buildspace/lldb-mi/build/src/lldb-mi ./bin/.

        # Set rpath for dylib
        install_name_tool -add_rpath @rpath/LLDB.framework/Versions/A/LLDB ./bin/lldb-mi

  - task: PublishPipelineArtifact@1
    displayName: 'Publish LLDB-MI'
    inputs:
      targetPath: '$(Build.StagingDirectory)/publish/bin/lldb-mi'
      artifactName: 'lldb-mi'